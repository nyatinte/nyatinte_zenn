---
title: "Prismaã®FluentAPIã§N+1å•é¡Œã«å¯¾å¿œã™ã‚‹"
emoji: "ğŸ˜Š"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["prisma","GraphQL"]
published: true
---

# ã¯ã˜ã‚ã«
Prismaã§GraphQL APIãªã©ã®é–‹ç™ºã‚’ã—ã¦ã„ã‚‹ã¨ã€N+1å•é¡Œã«é­é‡ã™ã‚‹ã“ã¨ãŒã‚ã‚‹ã¨æ€ã„ã¾ã™.
ä»Šå›ã¯ã€Prismaã®FluentAPIã‚’ä½¿ã£ã¦N+1å•é¡Œã«å¯¾å¿œã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™.

N+1å•é¡Œã‚„Prismaã«ã¤ã„ã¦ã¯æœ¬è¨˜äº‹ã§ã¯çœç•¥ã—ã¾ã™

# 1. å•é¡Œã®å†ç¾
https://zenn.dev/nyatinte/articles/656822f279cb37
ä¸Šè¨˜ã®è¨˜äº‹ã§ä½œæˆã—ãŸ[ã‚µãƒ³ãƒ—ãƒ«ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/nyatinte/bun-yoga-server-preset-test/blob/05e2a8520a021d7895b565a675277d23843f6938/src/schema/user/resolvers/User.ts)ã‚’ä½¿ã„ã¾ã™
https://github.com/nyatinte/bun-yoga-server-preset-test
ãŠæ‰‹å…ƒã®ç’°å¢ƒã§`git clone`ã—ã¦READMEã«å¾“ã£ã¦ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’è¡Œãˆã°OKã§ã™

å®Ÿéš›ã«ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦å•é¡Œã‚’å†ç¾ã—ã¦ã¿ã¾ã™
```sh:sh
bun start
```
ã§ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ãŸã‚‰ã€ç°¡å˜ãªã‚¯ã‚¨ãƒªã‚’æŠ•ã’ã¦ã¿ã¾ã™
```GraphQL:localhost
{
  users {
    id
    posts {
      id
    }
  }
}
```

ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’è¦‹ã¦ã¿ã‚‹ã¨Queryã®ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ã®ãŒã‚ã‹ã‚Šã¾ã™
```sh:Queryã®ãƒ­ã‚°
prisma:query SELECT `main`.`User`.`id`, `main`.`User`.`firstName`, `main`.`User`.`lastName`, `main`.`User`.`createdAt`, `main`.`User`.`updatedAt` FROM `main`.`User` WHERE 1=1 LIMIT ? OFFSET ?
prisma:query SELECT `main`.`Post`.`id`, `main`.`Post`.`title`, `main`.`Post`.`content`, `main`.`Post`.`published`, `main`.`Post`.`authorId`, `main`.`Post`.`createdAt`, `main`.`Post`.`updatedAt` FROM `main`.`Post` WHERE `main`.`Post`.`authorId` IN (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?) LIMIT ? OFFSET ?
prisma:query SELECT `main`.`Post`.`id`, `main`.`Post`.`title`, `main`.`Post`.`content`, `main`.`Post`.`published`, `main`.`Post`.`authorId`, `main`.`Post`.`createdAt`, `main`.`Post`.`updatedAt` FROM `main`.`Post` WHERE `main`.`Post`.`authorId` = ? LIMIT ? OFFSET ?
prisma:query SELECT `main`.`Post`.`id`, `main`.`Post`.`title`, `main`.`Post`.`content`, `main`.`Post`.`published`, `main`.`Post`.`authorId`, `main`.`Post`.`createdAt`, `main`.`Post`.`updatedAt` FROM `main`.`Post` WHERE `main`.`Post`.`authorId` = ? LIMIT ? OFFSET ?
...
prisma:query SELECT `main`.`Post`.`id`, `main`.`Post`.`title`, `main`.`Post`.`content`, `main`.`Post`.`published`, `main`.`Post`.`authorId`, `main`.`Post`.`createdAt`, `main`.`Post`.`updatedAt` FROM `main`.`Post` WHERE `main`.`Post`.`authorId` = ? LIMIT ? OFFSET ?
prisma:query SELECT `main`.`Post`.`id`, `main`.`Post`.`title`, `main`.`Post`.`content`, `main`.`Post`.`published`, `main`.`Post`.`authorId`, `main`.`Post`.`createdAt`, `main`.`Post`.`updatedAt` FROM `main`.`Post` WHERE `main`.`Post`.`authorId` = ? LIMIT ? OFFSET ?
```

å¤§é‡ã®ã‚¯ã‚¨ãƒªãŒç™ºè¡Œã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™
ã“ã‚Œã‚’FluentAPIã‚’ä½¿ç”¨ã—ã¦è§£æ±ºã—ã¦ã„ãã¾ã™

# 2. FluentAPIã‚’ä½¿ã£ãŸN+1å•é¡Œã®è§£æ±º
å®Ÿè£…ã‚’FluentAPIã«å¤‰æ›´ã—ã¾ã™

```ts diff:src/schema/user/resolvers/User.ts
import type { UserResolvers } from './../../types.generated';
export const User: UserResolvers = {
  fullName: (parent) => `${parent.firstName} ${parent.lastName}`,
  posts: (parent, _, { prisma }) => {
    /** using Fluent API */
+    return prisma.user.findUnique({ where: { id: parent.id } }).posts();

    /** not using Fluent API */
-    return prisma.post.findMany({ where: { authorId: parent.id } });
  },
};
```

ã‚‚ã†ä¸€åº¦ã‚¯ã‚¨ãƒªã‚’æŠ•ã’ã¦ã¿ã¾ã™
```sh:Queryã®ãƒ­ã‚°
prisma:query SELECT `main`.`User`.`id`, `main`.`User`.`firstName`, `main`.`User`.`lastName`, `main`.`User`.`createdAt`, `main`.`User`.`updatedAt` FROM `main`.`User` WHERE 1=1 LIMIT ? OFFSET ?
prisma:query SELECT `main`.`Post`.`id`, `main`.`Post`.`title`, `main`.`Post`.`content`, `main`.`Post`.`published`, `main`.`Post`.`authorId`, `main`.`Post`.`createdAt`, `main`.`Post`.`updatedAt` FROM `main`.`Post` WHERE `main`.`Post`.`authorId` IN (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?) LIMIT ? OFFSET ?
prisma:query SELECT `main`.`User`.`id` FROM `main`.`User` WHERE `main`.`User`.`id` IN (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?) LIMIT ? OFFSET ?
prisma:query SELECT `main`.`Post`.`id`, `main`.`Post`.`title`, `main`.`Post`.`content`, `main`.`Post`.`published`, `main`.`Post`.`authorId`, `main`.`Post`.`createdAt`, `main`.`Post`.`updatedAt` FROM `main`.`Post` WHERE `main`.`Post`.`authorId` IN (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?) LIMIT ? OFFSET ?
```
ç™ºè¡Œã•ã‚Œã‚‹ã‚¯ã‚¨ãƒªãŒå¤§ããæ¸›ã£ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™

# 3. ãªã‚“ã§ã“ã†ãªã‚‹ã®ï¼Ÿ
https://www.prisma.io/docs/guides/performance-and-optimization/query-optimization-performance#solving-n1-in-graphql-with-findunique-and-prismas-dataloader

https://www.prisma.io/docs/concepts/components/prisma-client/relation-queries#fluent-api


ç°¡å˜ã«èª¬æ˜ã™ã‚‹ã¨ã€Prismaã®DataLoaderãŒ**åŒã˜ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**ã¨ **é¸æŠã‚»ãƒƒãƒˆ(includeãªã©)** ã‚’æŒã¤**ã‚¯ã‚¨ãƒªã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã€ãƒãƒƒãƒå‡¦ç†ã‚’è¡Œã†**ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã‹ã‚‰ã§ã™.
è©³ç´°ã¯ä¸Šè¨˜ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„

# ã¾ã¨ã‚
ã“ã®è¨˜äº‹ã§ã¯ã€Prismaã®FluentAPIã‚’ä½¿ç”¨ã—ã¦N+1å•é¡Œã«å¯¾å‡¦ã™ã‚‹æ–¹æ³•ã‚’è§£èª¬ã—ã¾ã—ãŸ.
ç­‰ä¾¡ãªå‡¦ç†ã§ã‚‚æ›¸ãæ–¹1ã¤ã§å¤§ãããƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒå¤‰ã‚ã‚‹ã®ã§ã€ãœã²ä½¿ã£ã¦ã¿ã¦ãã ã•ã„ï¼